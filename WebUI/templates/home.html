<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
	<link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <title>Toxic Comment Detection</title>
    <style>
        /* Spinner styles */
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border-left-color: #09f;
            animation: spin 1s linear infinite;
            display: none; /* Initially hidden */
            margin: 10px auto;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Toxic Comment Detection</h1>

        <!-- Section 1: Load Video -->
            <form id='processForm' method='POST'>
                <div class="video-section">
                    <input type="text" id="youtube_url" name="youtube_url" placeholder="Enter Youtube URL..." />
                    <button id="load-button" onclick="loadVideo(event)">Load Video</button>
                    <button id="process-button" type='button' onclick="processVideo()">Process</button>
                    <div id="video-container" class="video-container"></div>
                </div>
            </form>

        <!-- Loading Spinner -->
        <div id="loading" class="spinner"></div>

        <!-- Section 2: Transcription Results -->
        <div class="transcription-results">
            <div class="left">
                <h2>Transcription Results</h2>
                <div id="transcription"></div>
            </div>
            <div class="right">
                <h2>NER Transcription Results</h2>
                <div id="ner-results"></div>
            </div>
        </div>

        <!-- Section 3: Comments Results -->
        <div class="comment-results">
            <div class="left">
                <h2>Comments Results</h2>
                <div id="comment-results"></div>
            </div>
            <div class="right">
                <h2>NER Comments Results</h2>
                <div id="ner-comment-results"></div>
            </div>
        </div>
        <!-- Section 5: Test Results -->
        <div class="test-results">
            <h2>Results</h2>
            <div id="test-output"></div>
            <form action="/download" method="get">
                <div class="video-section">
                    <button type="submit">Download Results</button>
                </div>
            </form>
            
        </div>
    </div>

    <script>
        function loadVideo(event) {
            event.preventDefault(); // Prevent the default form submission
            const url = document.getElementById("youtube_url").value;
            const videoId = getYouTubeID(url);
            if (videoId) {
                const videoContainer = document.getElementById("video-container");
                videoContainer.innerHTML = `<iframe width="560" height="315" src="https://www.youtube.com/embed/${videoId}" frameborder="0" allowfullscreen></iframe>`;
            } else {
                alert("Please enter validate URL.");
            }
        }
        
        function getYouTubeID(url) {
            const regex = /(?:https?:\/\/)?(?:www\.)?(?:youtube\.com\/(?:[^\/\n\s]+\/\S+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^&\n]{11})/;
            const matches = url.match(regex);
            return matches ? matches[1] : null;
        }

        function processVideo() {
            const formData = new FormData(document.getElementById('processForm'));
            document.getElementById('loading').style.display = 'block';
            fetch('/process', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                loadCSVData(data.output_cleaned_comment_path, 'comment-results');
                loadCSVData(data.output_cleaned_transcript_path, 'transcription');
                loadCSVData(data.output_cleaned_NER_comment_path, 'ner-comment-results');
                loadCSVData(data.output_cleaned_NER_transcript_path, 'ner-results');
            })
            .catch(error => console.error('Error:', error))
            .finally(() => {
                document.getElementById('loading').style.display = 'none'; // Hide the spinner
            });
        }

        function predictData() {
            const formData = new FormData(document.getElementById('predictForm'));
            
            fetch('/predict', {
                method: 'POST',
                body: formData
            })
            .then(response => response.text())
            .then(data => {
                document.getElementById('message').innerHTML = data;
            })
            .catch(error => console.error('Error:', error));
        }

        function loadCSVData(csvFilename, elementId) {
            if (!csvFilename) {
                console.error(`Filename for ${elementId} is undefined.`);
                return;
            }
            
            // Construct the full URL for the CSV endpoint
            const csvUrl = `${window.location.origin}/csv/${csvFilename}`;
            console.log(`Fetching CSV from: ${csvUrl}`);  // Log for debugging
            
            fetch(csvUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Network response was not ok: ${response.statusText}`);
                    }
                    return response.text();
                })
                .then(text => {
                    const rows = text.split('\n').map(row => row.split(','));
                    const table = document.createElement('table');
                    rows.forEach(row => {
                        const tr = document.createElement('tr');
                        row.forEach(cell => {
                            const td = document.createElement('td');
                            td.textContent = cell;
                            tr.appendChild(td);
                        });
                        table.appendChild(tr);
                    });
                    document.getElementById(elementId).innerHTML = '';  // Clear previous content
                    document.getElementById(elementId).appendChild(table);
                })
                .catch(error => console.error('Error loading CSV:', error));
        }
    </script>
    <script src="https://code.jquery.com/jquery-3.5.1.js" integrity="sha256-QWo7LDvxbWT2tbbQ97B53yJnYU3WhH/C8ycbRAkjPDc=" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/materialize/1.0.0/js/materialize.min.js"></script>
</body>
</html>